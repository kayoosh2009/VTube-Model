<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VTuber - Simple</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: transparent; /* для OBS — включи Transparent background в Browser Source */
      -webkit-user-select: none;
      user-select: none;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .page {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* Аватар (одна картинка меняется) */
    #avatar {
      max-height: 85vh;
      max-width: 95vw;
      display: block;
      pointer-events: none;
    }

    /* Контролы (ползунок) внизу по центру */
    #controls {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 10px;
      /* полупрозрачная подложка — можно удалить если нужен полностью прозрачный дизайн */
      background: rgba(0,0,0,0.25);
      color: #fff;
      font-size: 13px;
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
    }

    /* Ползунок */
    #volume-control {
      width: 220px;
      appearance: none;
      height: 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.15);
      outline: none;
    }
    #volume-control::-webkit-slider-thumb {
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 0 6px rgba(0,0,0,0.4);
      cursor: pointer;
    }

    /* Кнопка-призрак в правом верхнем углу */
    #secret-button {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 38px;
      height: 38px;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.08);
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: opacity 0.18s ease, transform 0.12s;
      opacity: 0; /* невидима по умолчанию */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    /* когда наводят на неё мышкой — становится видимой */
    #secret-button:hover,
    #secret-button:focus {
      opacity: 1;
      transform: scale(1.02);
      background: rgba(255,255,255,0.16);
      outline: none;
    }

    /* скрытие контролов (ползунка) */
    .hidden {
      display: none !important;
    }

    /* небольшая подсказка-лейбл слева от ползунка */
    .label {
      color: #fff;
      opacity: 0.9;
      font-size: 13px;
      white-space: nowrap;
    }

    /* для чтимости на тёмном фоне */
    @media (prefers-color-scheme: light) {
      #controls { background: rgba(255,255,255,0.12); color: #000; }
      #secret-button { background: rgba(0,0,0,0.06); color: #000; }
      #volume-control { background: rgba(0,0,0,0.06); }
      #volume-control::-webkit-slider-thumb { background: #000; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Аватар (подставляй свои картинки в папке img/) -->
    <img id="avatar" src="img/idle.png" alt="avatar">

    <!-- Скрытая кнопка -->
    <button id="secret-button" title="Показать/скрыть настройки">⚙</button>

    <!-- Контролы: метка + ползунок порога -->
    <div id="controls">
      <div class="label">Порог:</div>
      <input id="volume-control" type="range" min="0" max="0.3" step="0.01" value="0.05" />
      <div id="val" class="label" aria-hidden="true">0.05</div>
    </div>
  </div>

  <script>
    // ---------- Конфигурация путей к картинкам ----------
    const images = {
      idle: "img/idle.png",           // рот закрыт, глаза открыты
      blink: "img/blink.png",         // рот закрыт, глаза закрыты
      talk: "img/talk.png",           // рот открыт, глаза открыты
      talk_blink: "img/talk_blink.png"// рот открыт, глаза закрыты
    };

    // ---------- DOM ----------
    const avatar = document.getElementById("avatar");
    const secretButton = document.getElementById("secret-button");
    const controls = document.getElementById("controls");
    const volumeControl = document.getElementById("volume-control");
    const valLabel = document.getElementById("val");

    // ---------- Состояния ----------
    let isBlinking = false;   // true когда глаза закрыты
    let isTalking = false;    // true когда звук выше порога
    let threshold = parseFloat(volumeControl.value); // порог
    valLabel.textContent = threshold.toFixed(2);

    // ---------- Скрыть/показать ползунок по кнопке ----------
    secretButton.addEventListener("click", () => {
      controls.classList.toggle("hidden");
    });

    // ---------- Обновление порога из ползунка ----------
    volumeControl.addEventListener("input", () => {
      threshold = parseFloat(volumeControl.value);
      valLabel.textContent = threshold.toFixed(2);
    });

    // ---------- Блок двойного моргания каждые 3 секунды ----------
    let blinkLock = false;
    const BlinkCloseMs = 110;   // как быстро закрываем глаза
    const BetweenMs = 120;      // пауза между морганиями в паре
    function blinkTwice() {
      if (blinkLock) return;
      blinkLock = true;

      // 1) закрыть
      isBlinking = true; updateAvatar();
      setTimeout(() => {
        // открыть
        isBlinking = false; updateAvatar();

        setTimeout(() => {
          // 2) закрыть
          isBlinking = true; updateAvatar();

          setTimeout(() => {
            // открыть и разблокировать
            isBlinking = false; updateAvatar();
            blinkLock = false;
          }, BlinkCloseMs);
        }, BetweenMs);
      }, BlinkCloseMs);
    }
    // Запускаем по таймеру каждые 3000 мс (3 секунды)
    setInterval(() => blinkTwice(), 3000);

    // ---------- Микрофон — измерение громкости (RMS из time domain) ----------
    // Сглаживание (экспоненциальное)
    let smoothVolume = 0;
    const smoothingAlpha = 0.18; // чем меньше — тем сильнее сглаживание (0..1)

    function startMic() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.error("getUserMedia не поддерживается в этом браузере.");
        return;
      }

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          const audioCtx = new AudioCtx();
          const source = audioCtx.createMediaStreamSource(stream);
          const analyser = audioCtx.createAnalyser();
          analyser.fftSize = 1024; // размер буфера
          source.connect(analyser);

          const bufferLength = analyser.fftSize;
          const dataArray = new Uint8Array(bufferLength);

          function update() {
            analyser.getByteTimeDomainData(dataArray);
            // RMS
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
              const v = (dataArray[i] - 128) / 128; // -1..1
              sum += v * v;
            }
            const rms = Math.sqrt(sum / bufferLength); // 0..~1

            // сглаживаем
            smoothVolume = smoothVolume * (1 - smoothingAlpha) + rms * smoothingAlpha;

            // сравниваем с порогом
            isTalking = smoothVolume > threshold;

            updateAvatar();
            requestAnimationFrame(update);
          }

          update();
        })
        .catch(err => {
          console.error("Ошибка доступа к микрофону:", err);
        });
    }

    // ---------- Функция обновления картинки ----------
    function updateAvatar() {
      // Выбираем в порядке важности
      // если говорим + морг — talk_blink
      // если говорим — talk
      // если молчим + морг — blink
      // иначе idle
      if (isTalking && isBlinking) {
        avatar.src = images.talk_blink;
      } else if (isTalking) {
        avatar.src = images.talk;
      } else if (isBlinking) {
        avatar.src = images.blink;
      } else {
        avatar.src = images.idle;
      }
    }

    // ---------- Подгрузка изображений (чтобы избежать мерцаний) ----------
    function preloadImages(paths) {
      Object.values(paths).forEach(p => {
        const i = new Image();
        i.src = p;
      });
    }
    preloadImages(images);

    // ---------- Старт ----------
    startMic();
    updateAvatar();
  </script>
</body>
</html>
