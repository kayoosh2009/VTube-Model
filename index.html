<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>VTuber</title>
  <style>
    body {
      margin: 0;
      background: transparent; /* прозрачный фон */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: sans-serif;
    }

    #avatar {
      max-height: 80vh;
      pointer-events: none;
      user-select: none;
    }

    /* Ползунок громкости */
    #volume-control {
      margin-top: 10px;
      width: 200px;
    }

    /* Скрытая кнопка */
    #secret-button {
      position: absolute;
      top: 10px;
      right: 10px;
      opacity: 0;
      transition: opacity 0.3s;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid #fff;
      border-radius: 5px;
      cursor: pointer;
      color: white;
    }
    #secret-button:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.4);
    }
    #secret-button.show {
      opacity: 0.2;
    }
  </style>
</head>
<body>
  <img id="avatar" src="img/idle.png" alt="avatar">

  <!-- Ползунок громкости -->
  <input type="range" id="volume-control" min="0" max="0.3" step="0.01" value="0.05">

  <!-- Скрытая кнопка -->
  <button id="secret-button" class="show">Секрет</button>

  <script>
    const avatar = document.getElementById("avatar");
    const volumeControl = document.getElementById("volume-control");
    const secretButton = document.getElementById("secret-button");

    const images = {
      idle: "img/idle.png",
      blink: "img/blink.png",
      talk: "img/talk.png",
      talk_blink: "img/talk_blink.png"
    };

    let isBlinking = false;
    let isTalking = false;
    let threshold = parseFloat(volumeControl.value);

    // ---- Моргание ----
    function startBlinking() {
      const blinkDelay = Math.random() * 3000 + 3000; // 3-6 секунд
      setTimeout(() => {
        isBlinking = true;
        updateAvatar();
        setTimeout(() => {
          isBlinking = false;
          updateAvatar();
        }, 200); // длительность моргания
        startBlinking();
      }, blinkDelay);
    }
    startBlinking();

    // ---- Ползунок громкости ----
    volumeControl.addEventListener("input", () => {
      threshold = parseFloat(volumeControl.value);
    });

    // ---- Микрофон ----
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      const audioCtx = new AudioContext();
      const source = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 512;

      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      source.connect(analyser);

      // Сглаживание громкости
      let smoothVolume = 0;
      const smoothing = 0.2;

      function checkVolume() {
        analyser.getByteFrequencyData(dataArray);
        let values = 0;
        for (let i = 0; i < dataArray.length; i++) {
          values += dataArray[i];
        }
        let average = values / dataArray.length / 255; // 0–1

        smoothVolume = smoothVolume * (1 - smoothing) + average * smoothing;

        isTalking = smoothVolume > threshold;
        updateAvatar();

        requestAnimationFrame(checkVolume);
      }

      checkVolume();
    }).catch(err => {
      console.error("Ошибка доступа к микрофону:", err);
    });

    // ---- Обновление картинки ----
    function updateAvatar() {
      if (isTalking && isBlinking) {
        avatar.src = images.talk_blink;
      } else if (isTalking && !isBlinking) {
        avatar.src = images.talk;
      } else if (!isTalking && isBlinking) {
        avatar.src = images.blink;
      } else {
        avatar.src = images.idle;
      }
    }
  </script>
</body>
</html>
